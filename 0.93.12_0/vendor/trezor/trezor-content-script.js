(()=>{"use strict";var e={928:e=>{var t,n="object"==typeof Reflect?Reflect:null,r=n&&"function"==typeof n.apply?n.apply:function(e,t,n){return Function.prototype.apply.call(e,t,n)};t=n&&"function"==typeof n.ownKeys?n.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var s=Number.isNaN||function(e){return e!=e};function i(){i.init.call(this)}e.exports=i,e.exports.once=function(e,t){return new Promise((function(n,r){function s(n){e.removeListener(t,i),r(n)}function i(){"function"==typeof e.removeListener&&e.removeListener("error",s),n([].slice.call(arguments))}v(e,t,i,{once:!0}),"error"!==t&&function(e,t,n){"function"==typeof e.on&&v(e,"error",t,n)}(e,s,{once:!0})}))},i.EventEmitter=i,i.prototype._events=void 0,i.prototype._eventsCount=0,i.prototype._maxListeners=void 0;var o=10;function a(e){if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function h(e){return void 0===e._maxListeners?i.defaultMaxListeners:e._maxListeners}function c(e,t,n,r){var s,i,o,c;if(a(n),void 0===(i=e._events)?(i=e._events=Object.create(null),e._eventsCount=0):(void 0!==i.newListener&&(e.emit("newListener",t,n.listener?n.listener:n),i=e._events),o=i[t]),void 0===o)o=i[t]=n,++e._eventsCount;else if("function"==typeof o?o=i[t]=r?[n,o]:[o,n]:r?o.unshift(n):o.push(n),(s=h(e))>0&&o.length>s&&!o.warned){o.warned=!0;var u=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");u.name="MaxListenersExceededWarning",u.emitter=e,u.type=t,u.count=o.length,c=u,console&&console.warn&&console.warn(c)}return e}function u(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function l(e,t,n){var r={fired:!1,wrapFn:void 0,target:e,type:t,listener:n},s=u.bind(r);return s.listener=n,r.wrapFn=s,s}function d(e,t,n){var r=e._events;if(void 0===r)return[];var s=r[t];return void 0===s?[]:"function"==typeof s?n?[s.listener||s]:[s]:n?function(e){for(var t=new Array(e.length),n=0;n<t.length;++n)t[n]=e[n].listener||e[n];return t}(s):f(s,s.length)}function p(e){var t=this._events;if(void 0!==t){var n=t[e];if("function"==typeof n)return 1;if(void 0!==n)return n.length}return 0}function f(e,t){for(var n=new Array(t),r=0;r<t;++r)n[r]=e[r];return n}function v(e,t,n,r){if("function"==typeof e.on)r.once?e.once(t,n):e.on(t,n);else{if("function"!=typeof e.addEventListener)throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof e);e.addEventListener(t,(function s(i){r.once&&e.removeEventListener(t,s),n(i)}))}}Object.defineProperty(i,"defaultMaxListeners",{enumerable:!0,get:function(){return o},set:function(e){if("number"!=typeof e||e<0||s(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");o=e}}),i.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},i.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||s(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},i.prototype.getMaxListeners=function(){return h(this)},i.prototype.emit=function(e){for(var t=[],n=1;n<arguments.length;n++)t.push(arguments[n]);var s="error"===e,i=this._events;if(void 0!==i)s=s&&void 0===i.error;else if(!s)return!1;if(s){var o;if(t.length>0&&(o=t[0]),o instanceof Error)throw o;var a=new Error("Unhandled error."+(o?" ("+o.message+")":""));throw a.context=o,a}var h=i[e];if(void 0===h)return!1;if("function"==typeof h)r(h,this,t);else{var c=h.length,u=f(h,c);for(n=0;n<c;++n)r(u[n],this,t)}return!0},i.prototype.addListener=function(e,t){return c(this,e,t,!1)},i.prototype.on=i.prototype.addListener,i.prototype.prependListener=function(e,t){return c(this,e,t,!0)},i.prototype.once=function(e,t){return a(t),this.on(e,l(this,e,t)),this},i.prototype.prependOnceListener=function(e,t){return a(t),this.prependListener(e,l(this,e,t)),this},i.prototype.removeListener=function(e,t){var n,r,s,i,o;if(a(t),void 0===(r=this._events))return this;if(void 0===(n=r[e]))return this;if(n===t||n.listener===t)0==--this._eventsCount?this._events=Object.create(null):(delete r[e],r.removeListener&&this.emit("removeListener",e,n.listener||t));else if("function"!=typeof n){for(s=-1,i=n.length-1;i>=0;i--)if(n[i]===t||n[i].listener===t){o=n[i].listener,s=i;break}if(s<0)return this;0===s?n.shift():function(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}(n,s),1===n.length&&(r[e]=n[0]),void 0!==r.removeListener&&this.emit("removeListener",e,o||t)}return this},i.prototype.off=i.prototype.removeListener,i.prototype.removeAllListeners=function(e){var t,n,r;if(void 0===(n=this._events))return this;if(void 0===n.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==n[e]&&(0==--this._eventsCount?this._events=Object.create(null):delete n[e]),this;if(0===arguments.length){var s,i=Object.keys(n);for(r=0;r<i.length;++r)"removeListener"!==(s=i[r])&&this.removeAllListeners(s);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=n[e]))this.removeListener(e,t);else if(void 0!==t)for(r=t.length-1;r>=0;r--)this.removeListener(e,t[r]);return this},i.prototype.listeners=function(e){return d(this,e,!0)},i.prototype.rawListeners=function(e){return d(this,e,!1)},i.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):p.call(e,t)},i.prototype.listenerCount=p,i.prototype.eventNames=function(){return this._eventsCount>0?t(this._events):[]}}},t={};function n(r){var s=t[r];if(void 0!==s)return s.exports;var i=t[r]={exports:{}};return e[r](i,i.exports,n),i.exports}n.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),(()=>{var e=n(928);class t extends e.EventEmitter{listenerCount(e){return super.listenerCount(e)}}const r="storage_v2";let s={origin:{}};const i=()=>{const e=localStorage.getItem(r);return e?JSON.parse(e):{origin:{}}};new class extends t{save(e,t=!1){if(!t&&n.g.window)try{const t=e(i());localStorage.setItem(r,JSON.stringify(t)),this.emit("changed",t)}catch(t){console.warn("long term storage not available"),s=e(s)}else s=e(s)}saveForOrigin(e,t,n=!1){this.save((n=>({...n,origin:{...n.origin,[t]:e(n.origin?.[t]||{})}})),n)}load(e=!1){if(e||!n.g?.window?.localStorage)return s;try{return i()}catch(e){return console.warn("long term storage not available"),s}}loadForOrigin(e,t=!1){const n=this.load(t);return n.origin?.[e]||{}}};const o=e=>{let t=()=>{},n=()=>{};const r=new Promise(((e,r)=>{t=e,n=r}));return{id:e,resolve:t,reject:n,promise:r}},a=e=>Array.isArray(e),h=()=>new Error("Aborted by signal"),c=()=>new Error("Aborted by deadline"),u=()=>new Error("Aborted by timeout"),l=(e,t)=>new Promise(((n,r)=>{if(t.aborted)return r();if(void 0===e)return n();const s=setTimeout(n,e),i=()=>{clearTimeout(s),t.removeEventListener("abort",i),r()};t.addEventListener("abort",i)})),d=(e,t,n)=>new Promise(((r,s)=>{if(n.aborted)return s();const i=void 0!==e?setTimeout((()=>s(t())),e):void 0,o=()=>{clearTimeout(i),n.removeEventListener("abort",o),s()};n.addEventListener("abort",o)})),p=(e,t)=>new Promise(((n,r)=>{if(t.aborted)return r();if(e?.aborted)return r(h());const s=()=>r(h());e?.addEventListener("abort",s);const i=()=>{e?.removeEventListener("abort",s),t.removeEventListener("abort",i),r()};t.addEventListener("abort",i)})),f=async(e,t)=>{const n=new AbortController,r=()=>n.abort();t.aborted&&r(),t.addEventListener("abort",r);try{return await new Promise((t=>t(e(n.signal))))}finally{t.removeEventListener("abort",r)}},v=async(e,t)=>{const{signal:n,delay:r,attempts:s,timeout:i,deadline:o,gap:h}=t,v=o&&o-Date.now(),m=a(s)?s.length:s??(o?1/0:1),g=new AbortController,y=g.signal,w=a(s)?e=>s[e]:()=>({timeout:i,gap:h});try{return await Promise.race([p(n,y),d(v,c,y),l(r,y).then((()=>(async(e,t,n,r)=>{for(let s=0;s<e-1&&!r.aborted;s++){const e=new AbortController,i=()=>e.abort();r.addEventListener("abort",i);try{return await t(s,e.signal)}catch{i(),await n(s)}finally{r.removeEventListener("abort",i)}}return r.aborted?Promise.reject():t(e-1,r)})(m,((t,n)=>Promise.race([d(w(t).timeout,u,y),f(e,n)])),(e=>l(w(e).gap??0,y)),y)))])}finally{g.abort()}};class m extends t{messagePromises={};messagesQueue=[];messageID=0;isConnected=!1;handshakeMaxRetries=5;handshakeRetryInterval=2e3;constructor({sendFn:e,channel:t,logger:n,lazyHandshake:r=!1,legacyMode:s=!1}){super(),this.channel=t,this.sendFn=e,this.lazyHandshake=r,this.legacyMode=s,this.logger=n}init(){return this.handshakeFinished||(this.handshakeFinished=o(),this.legacyMode&&setTimeout((()=>{this.handshakeFinished?.resolve()}),500),this.lazyHandshake||this.handshakeWithPeer()),this.handshakeFinished.promise}handshakeWithPeer(){return this.logger?.log(this.channel.here,"handshake"),v((async()=>{this.postMessage({type:"channel-handshake-request",data:{success:!0,payload:void 0}},{usePromise:!1,useQueue:!1}),await(this.handshakeFinished?.promise)}),{attempts:this.handshakeMaxRetries,timeout:this.handshakeRetryInterval}).then((()=>{this.logger?.log(this.channel.here,"handshake confirmed"),this.messagesQueue.forEach((e=>{e.channel=this.channel,this.sendFn(e)})),this.messagesQueue=[]})).catch((()=>{this.handshakeFinished?.reject(new Error("handshake failed")),this.handshakeFinished=void 0}))}onMessage(e){let t=e;this.legacyMode&&void 0===t.type&&"data"in t&&"object"==typeof t.data&&null!==t.data&&"type"in t.data&&"string"==typeof t.data.type&&(t=t.data);const{channel:n,id:r,type:s,payload:i,success:o}=t;if(!this.legacyMode){if(!n?.peer||n.peer!==this.channel.here)return;if(!n?.here||this.channel.peer!==n.here)return}if("channel-handshake-request"===s)return this.postMessage({type:"channel-handshake-confirm",data:{success:!0,payload:void 0}},{usePromise:!1,useQueue:!1}),void(this.lazyHandshake&&this.handshakeWithPeer());if("channel-handshake-confirm"===s)return void this.handshakeFinished?.resolve(void 0);this.messagePromises[r]&&(this.messagePromises[r].resolve({id:r,payload:i,success:o}),delete this.messagePromises[r]);const a=Object.keys(this.messagePromises).length;a>5&&this.logger?.warn(`too many message promises (${a}). this feels unexpected!`),this.emit("message",t)}postMessage(e,{usePromise:t=!0,useQueue:n=!0}={}){if(e.channel=this.channel,t){this.messageID++,e.id=this.messageID,this.messagePromises[e.id]=o();try{this.sendFn(e)}catch(t){n&&this.messagesQueue.push(e)}return this.messagePromises[e.id].promise}try{this.sendFn(e)}catch(t){n&&this.messagesQueue.push(e)}}resolveMessagePromises(e){Object.keys(this.messagePromises).forEach((t=>this.messagePromises[t].resolve({id:t,payload:e})))}clear(){this.handshakeFinished=void 0}}const g=new class extends m{constructor({name:e,channel:t}){super({channel:t,sendFn:e=>{if(!this.port)throw new Error("port not assigned");this.port.postMessage(e)}});const n=chrome.runtime.connect({name:e});this.port=n,this.connect()}connect(){this.port?.onMessage.addListener((e=>{e.channel.here!==this.channel.here&&this.onMessage(e)})),this.isConnected=!0}disconnect(){this.isConnected&&(this.port?.disconnect(),this.isConnected=!1)}}({name:"trezor-connect",channel:{here:"@trezor/connect-content-script",peer:"@trezor/connect-webextension"}});g.init().then((()=>{window.postMessage({type:"popup-content-script-loaded",payload:{...chrome.runtime.getManifest(),id:chrome.runtime.id}},window.location.origin),g.on("message",(e=>{window.postMessage(e,window.location.origin)})),window.addEventListener("message",(e=>{"@trezor/connect-webextension"!==e.data?.channel?.here&&"popup-content-script-loaded"!==e.data?.type&&e.source===window&&e.data&&g.postMessage(e.data,{usePromise:!1})})),window.addEventListener("beforeunload",(()=>{window.postMessage({type:"popup-closed"},window.location.origin)}))}))})()})();